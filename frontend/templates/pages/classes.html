{% extends "base.html" %}

{% block title %}Class Management - Academic Advisor{% endblock %}

{% block content %}
<div id="notification" class="notification"></div>

<div class="navbar">
    <div class="navbar-left">
        <a href="/dashboard">Dashboard</a>
        <a href="/classes" class="active">Class Management</a>
        <a href="/advising">Advising Chat</a>
    </div>
    <div class="navbar-right">
        <span class="navbar-username" id="username-display"></span>
        <button id="logout-btn">Logout</button>
    </div>
</div>

<div class="container">
    <h2>Class Management</h2>
    <p>Major: <span id="major-display"></span></p>
    
    <div id="course-management">
        <h3>Add a Completed Course</h3>
        
        <form id="add-course-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="department">Department:</label>
                    <input type="text" id="department" placeholder="e.g., CS, MATH, PHYS" required>
                </div>
                
                <div class="form-group">
                    <label for="course-number">Course Number:</label>
                    <input type="text" id="course-number" placeholder="e.g., 101, 210, 350" required>
                </div>
                
                <div class="form-group">
                    <label for="term">Term Taken:</label>
                    <select id="term">
                        <option value="">-- Select Term --</option>
                        <option value="Fall 2023">Fall 2023</option>
                        <option value="Spring 2023">Spring 2023</option>
                        <option value="Fall 2022">Fall 2022</option>
                        <option value="Spring 2022">Spring 2022</option>
                        <!-- Add more terms as needed -->
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="course-name">Course Name:</label>
                <input type="text" id="course-name" placeholder="e.g., Introduction to Computer Science">
            </div>
            
            <button type="submit" id="addCourseBtn">Add Course</button>
        </form>
        
        <h3>Your Completed Courses</h3>
        <div id="courseList">
            <!-- Courses will be added here dynamically -->
            <div class="no-courses-message">You haven't added any courses yet.</div>
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
<style>
    .form-row {
        display: flex;
        gap: 10px;
    }
    
    .form-group {
        flex: 1;
        margin-bottom: 15px;
    }
    
    .no-courses-message {
        font-style: italic;
        color: #777;
        text-align: center;
        padding: 20px;
    }
    
    .course-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f5f5f5;
        padding: 10px 15px;
        margin-bottom: 8px;
        border-radius: 4px;
        border-left: 4px solid #3498db;
    }
    
    .course-info {
        flex-grow: 1;
    }
    
    .course-code {
        font-weight: bold;
    }
    
    .course-name {
        color: #555;
    }
    
    .course-term {
        font-size: 0.9em;
        color: #777;
    }
    
    .course-actions {
        display: flex;
        gap: 5px;
    }
    
    .edit-btn {
        background-color: #f39c12;
    }
    
    .remove-btn {
        background-color: #e74c3c;
    }
    
    .edit-btn, .remove-btn {
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        margin-top: 0;
    }
    
    .edit-mode {
        background-color: #e8f4fc;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let token = localStorage.getItem('token');
    let currentUser = null;
    let userCourses = [];
    let editingCourseId = null;
    
    // Check if user is logged in on page load
    document.addEventListener('DOMContentLoaded', function() {
        if (!token) {
            // Redirect to login if not logged in
            window.location.href = '/';
            return;
        }
        
        // Fetch user data
        fetchUserData();
        
        // Set up event listeners
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('add-course-form').addEventListener('submit', handleAddCourse);
    });
    
    // Fetch user data
    async function fetchUserData() {
        try {
            const response = await fetch('/users/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                currentUser = await response.json();
                
                // Display user info
                document.getElementById('username-display').textContent = currentUser.username;
                document.getElementById('major-display').textContent = currentUser.major;
                
                // Load user courses
                loadUserCourses();
            } else {
                // Token might be expired or invalid
                logout();
            }
        } catch (error) {
            console.error('Error fetching user data:', error);
            logout();
        }
    }
    
    // Load user courses
    async function loadUserCourses() {
        try {
            const response = await fetch('/courses/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                userCourses = await response.json();
                updateCourseList();
            }
        } catch (error) {
            console.error('Error loading courses:', error);
        }
    }
    
    // Update course list
    function updateCourseList() {
        const courseList = document.getElementById('courseList');
        
        // Clear current list
        courseList.innerHTML = '';
        
        if (userCourses.length === 0) {
            courseList.innerHTML = '<div class="no-courses-message">You haven\'t added any courses yet.</div>';
            return;
        }
        
        // Add each course to the list
        userCourses.forEach(course => {
            const courseItem = document.createElement('div');
            courseItem.className = 'course-item';
            courseItem.dataset.id = course.id;
            
            if (editingCourseId === course.id) {
                // Render edit form
                courseItem.classList.add('edit-mode');
                courseItem.innerHTML = `
                    <div class="course-edit-form">
                        <div class="form-row">
                            <div class="form-group">
                                <input type="text" id="edit-department-${course.id}" value="${course.course_code.split(' ')[0]}" required>
                            </div>
                            <div class="form-group">
                                <input type="text" id="edit-number-${course.id}" value="${course.course_code.split(' ')[1]}" required>
                            </div>
                            <div class="form-group">
                                <input type="text" id="edit-term-${course.id}" value="${course.term || ''}" placeholder="Term">
                            </div>
                        </div>
                        <div class="form-group">
                            <input type="text" id="edit-name-${course.id}" value="${course.course_name}" placeholder="Course Name">
                        </div>
                        <div class="course-actions">
                            <button class="save-btn" onclick="saveCourseEdit(${course.id})">Save</button>
                            <button class="cancel-btn" onclick="cancelEdit()">Cancel</button>
                        </div>
                    </div>
                `;
            } else {
                // Render course display
                courseItem.innerHTML = `
                    <div class="course-info">
                        <div class="course-code">${course.course_code}</div>
                        <div class="course-name">${course.course_name}</div>
                        ${course.term ? `<div class="course-term">Term: ${course.term}</div>` : ''}
                    </div>
                    <div class="course-actions">
                        <button class="edit-btn" onclick="editCourse(${course.id})">Edit</button>
                        <button class="remove-btn" onclick="removeCourse(${course.id})">Remove</button>
                    </div>
                `;
            }
            
            courseList.appendChild(courseItem);
        });
    }
    
    // Handle add course form submission
    async function handleAddCourse(e) {
        e.preventDefault();
        
        const department = document.getElementById('department').value.trim().toUpperCase();
        const courseNumber = document.getElementById('course-number').value.trim();
        const courseName = document.getElementById('course-name').value.trim();
        const term = document.getElementById('term').value;
        
        if (!department || !courseNumber) {
            showNotification('Please enter both department and course number', false);
            return;
        }
        
        const courseCode = `${department} ${courseNumber}`;
        const courseString = courseName ? `${courseCode} - ${courseName}` : courseCode;
        
        try {
            const formData = new FormData();
            formData.append('course_string', courseString);
            
            if (term) {
                // Note: The backend needs to be updated to handle the term parameter
                formData.append('term', term);
            }
            
            const response = await fetch('/courses/add', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            
            if (response.ok) {
                // Clear form
                document.getElementById('department').value = '';
                document.getElementById('course-number').value = '';
                document.getElementById('course-name').value = '';
                document.getElementById('term').value = '';
                
                // Show success message
                showNotification('Course added successfully!');
                
                // Reload courses
                loadUserCourses();
            } else {
                const data = await response.json();
                showNotification(data.detail || 'Failed to add course', false);
            }
        } catch (error) {
            console.error('Error adding course:', error);
            showNotification('An error occurred while adding the course', false);
        }
    }
    
    // Edit course
    function editCourse(courseId) {
        editingCourseId = courseId;
        updateCourseList();
    }
    
    // Cancel edit
    function cancelEdit() {
        editingCourseId = null;
        updateCourseList();
    }
    
    // Save course edit
    async function saveCourseEdit(courseId) {
        const department = document.getElementById(`edit-department-${courseId}`).value.trim().toUpperCase();
        const courseNumber = document.getElementById(`edit-number-${courseId}`).value.trim();
        const courseName = document.getElementById(`edit-name-${courseId}`).value.trim();
        const term = document.getElementById(`edit-term-${courseId}`).value.trim();
        
        if (!department || !courseNumber) {
            showNotification('Please enter both department and course number', false);
            return;
        }
        
        const courseCode = `${department} ${courseNumber}`;
        const courseString = courseName ? `${courseCode} - ${courseName}` : courseCode;
        
        try {
            // Note: The backend needs to be updated to handle course editing
            // For now, we'll remove the old course and add the new one
            await removeCourse(courseId, false);
            
            const formData = new FormData();
            formData.append('course_string', courseString);
            
            if (term) {
                formData.append('term', term);
            }
            
            const response = await fetch('/courses/add', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            
            if (response.ok) {
                // Show success message
                showNotification('Course updated successfully!');
                
                // Reset editing state
                editingCourseId = null;
                
                // Reload courses
                loadUserCourses();
            } else {
                const data = await response.json();
                showNotification(data.detail || 'Failed to update course', false);
            }
        } catch (error) {
            console.error('Error updating course:', error);
            showNotification('An error occurred while updating the course', false);
        }
    }
    
    // Remove course
    async function removeCourse(courseId, showMessage = true) {
        try {
            const response = await fetch(`/courses/remove/${courseId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                if (showMessage) {
                    // Show success message
                    showNotification('Course removed successfully!');
                }
                
                // Reload courses
                loadUserCourses();
                return true;
            } else {
                const data = await response.json();
                showNotification(data.detail || 'Failed to remove course', false);
                return false;
            }
        } catch (error) {
            console.error('Error removing course:', error);
            showNotification('An error occurred while removing the course', false);
            return false;
        }
    }
    
    // Logout function
    function logout() {
        token = null;
        currentUser = null;
        localStorage.removeItem('token');
        window.location.href = '/';
    }
    
    // Show notification
    function showNotification(message, isSuccess = true) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.backgroundColor = isSuccess ? '#27ae60' : '#e74c3c';
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
</script>
{% endblock %} 